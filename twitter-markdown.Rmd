---
title: "twitter-scraper"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(rtweet)
require(ggthemes)
require(lubridate)
require(tidytext)
require(tidyverse)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r old work}
get_tweets <- function(q, geocode){
  temp <- search_tweets2(q = q, n = 15000, include_rts = FALSE, geocode = lookup_coords(geocode), retryonratelimit = TRUE) 
  temp2 <- temp %>%
    select(created_at, text, query) %>%
    mutate(location = geocode,
         eastern_time = with_tz(created_at, tzone = "America/New_York"))
  temp2$new_time <- as.POSIXct(trunc(temp2$eastern_time, "mins"))
  return(temp2)
}

sentimentize_tweets <- function(x, start, end){
  temp <- unnest_tokens(x, "word", text) %>%
    inner_join(get_sentiments("afinn")) %>%
    mutate(time_bucket = round_date(new_time, "5 minutes")) %>%
    group_by(location, time_bucket) %>% summarise(sentiment = sum(score), words = n()) %>%
    mutate(avg_sentiment = sentiment/words) %>%
    filter(time_bucket >= mdy_hms(start, tz = "America/New_York"),
           time_bucket <= mdy_hms(end, tz = "America/New_York"))
  return(temp)
}

city1a <- get_tweets(q = "Bruins OR Leafs", geocode = "Boston")
city1b <- sentimentize_tweets(test, start = "4/25/2018 19:00:00", end = "4/25/2018 23:00:00")
city2a <- get_tweets(q = "Bruins OR Leafs", geocode = "Toronto")
city2b <- sentimentize_tweets(testa, start = "4/25/2018 19:00:00", end = "4/25/2018 23:00:00")
combined <- bind_rows(city1b, city2b)

ggplot(data = combined, aes(x = time_bucket, y = avg_sentiment, group = location)) + geom_line(aes(group = location, color = location)) +
  labs(title = "Twitter Sentiment of Bruins vs. Leafs", subtitle = "Tweets containing 'Bruins' or 'Leafs'", 
       caption = "@AlexNovet", x = "Time (Eastern)", y = "Average Sentiment")+ 
  theme_few()
            
```

Future Steps:

2. Need to clean plotting to include vertical lines for period starts and ends, better theme
3. Add comments
4. Can I limit time of tweets?